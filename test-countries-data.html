<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Countries Data Test - BD TicketPro</title>
    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          sans-serif;
        margin: 20px;
        background: #f5f5f5;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .country-card {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
        background: #f9fafb;
      }
      .country-card.has-tickets {
        background: #f0fdf4;
        border-color: #10b981;
      }
      .country-card.no-tickets {
        background: #fef2f2;
        border-color: #ef4444;
      }
      .status {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
      }
      .status.success {
        background: #10b981;
        color: white;
      }
      .status.error {
        background: #ef4444;
        color: white;
      }
      .status.pending {
        background: #6b7280;
        color: white;
      }
      .logs {
        background: #1f2937;
        color: #f9fafb;
        padding: 15px;
        border-radius: 5px;
        font-family: monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
        margin: 20px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸŒ Countries Data Verification Test</h1>
      <p>Testing BD TicketPro Countries page with comprehensive data</p>

      <button onclick="testCountriesData()">ğŸ§ª Test Countries Data</button>
      <button onclick="clearLogs()">ğŸ§¹ Clear Logs</button>

      <div class="logs" id="logs">Test logs will appear here...\n</div>

      <div id="countries-results"></div>
    </div>

    <script>
      const baseUrl =
        "https://c25997cb5eee49c0ba2ee85ce1d3a4de-44913b1f46c54642a13e69ecd.fly.dev";
      let authToken = null;

      function log(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        const logElement = document.getElementById("logs");
        const prefix =
          type === "error"
            ? "âŒ"
            : type === "success"
              ? "âœ…"
              : type === "warning"
                ? "âš ï¸"
                : "â„¹ï¸";
        logElement.textContent += `[${timestamp}] ${prefix} ${message}\n`;
        logElement.scrollTop = logElement.scrollHeight;
      }

      async function login() {
        log("ğŸ” Logging in with admin credentials...");
        try {
          const response = await fetch(`${baseUrl}/api/auth/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              username: "admin",
              password: "admin123",
            }),
          });

          const data = await response.json();
          if (data.success && data.data.token) {
            authToken = data.data.token;
            log(`âœ… Login successful! User: ${data.data.user.name}`, "success");
            return true;
          } else {
            throw new Error(data.message || "Login failed");
          }
        } catch (error) {
          log(`âŒ Login failed: ${error.message}`, "error");
          return false;
        }
      }

      async function fetchCountriesData() {
        log("ğŸŒ Fetching countries data...");
        try {
          const response = await fetch(
            `${baseUrl}/api/tickets/countries/stats`,
            {
              headers: { Authorization: `Bearer ${authToken}` },
            },
          );

          const data = await response.json();
          if (data.success && data.data && data.data.countries) {
            log(`âœ… Countries data fetched successfully!`, "success");
            log(`ğŸ“Š Total countries: ${data.data.countries.length}`, "info");
            return data.data.countries;
          } else {
            throw new Error(data.message || "Failed to fetch countries");
          }
        } catch (error) {
          log(`âŒ Failed to fetch countries: ${error.message}`, "error");
          return [];
        }
      }

      function displayCountriesData(countries) {
        const resultsDiv = document.getElementById("countries-results");
        resultsDiv.innerHTML = "<h2>ğŸ“‹ Countries Data Results</h2>";

        let totalTickets = 0;
        let totalAvailable = 0;
        let countriesWithTickets = 0;

        countries.forEach((country) => {
          const hasTickets = country.totalTickets > 0;
          if (hasTickets) countriesWithTickets++;

          totalTickets += country.totalTickets || 0;
          totalAvailable += country.availableTickets || 0;

          const card = document.createElement("div");
          card.className = `country-card ${hasTickets ? "has-tickets" : "no-tickets"}`;
          card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3>${country.flag} ${country.name} (${country.code})</h3>
                            <p>Total Tickets: <strong>${country.totalTickets || 0}</strong></p>
                            <p>Available: <strong>${country.availableTickets || 0}</strong></p>
                        </div>
                        <div>
                            <span class="status ${hasTickets ? "success" : "error"}">
                                ${hasTickets ? "HAS TICKETS" : "NO TICKETS"}
                            </span>
                        </div>
                    </div>
                `;
          resultsDiv.appendChild(card);
        });

        // Summary
        const summary = document.createElement("div");
        summary.style.marginTop = "20px";
        summary.style.padding = "15px";
        summary.style.background = "#eff6ff";
        summary.style.borderRadius = "8px";
        summary.innerHTML = `
                <h3>ğŸ“Š Summary</h3>
                <p><strong>Total Countries:</strong> ${countries.length}</p>
                <p><strong>Countries with Tickets:</strong> ${countriesWithTickets}</p>
                <p><strong>Total Tickets:</strong> ${totalTickets}</p>
                <p><strong>Available Tickets:</strong> ${totalAvailable}</p>
                <p><strong>Success Rate:</strong> ${Math.round((countriesWithTickets / countries.length) * 100)}%</p>
            `;
        resultsDiv.appendChild(summary);

        // Log summary
        log(
          `ğŸ“Š Summary: ${countriesWithTickets}/${countries.length} countries have tickets`,
          "info",
        );
        log(
          `ğŸ« Total tickets: ${totalTickets}, Available: ${totalAvailable}`,
          "info",
        );
      }

      async function testCountriesData() {
        log("ğŸš€ Starting Countries Data Test...");

        // Clear previous results
        document.getElementById("countries-results").innerHTML = "";

        // Step 1: Login
        const loginSuccess = await login();
        if (!loginSuccess) return;

        // Step 2: Fetch countries data
        const countries = await fetchCountriesData();
        if (countries.length === 0) return;

        // Step 3: Display results
        displayCountriesData(countries);

        log("ğŸ‰ Countries data test completed!", "success");
      }

      function clearLogs() {
        document.getElementById("logs").textContent = "Test logs cleared...\n";
      }

      // Show initial message
      log("ğŸ¯ BD TicketPro Countries Data Test Ready");
      log(
        'ğŸ“‹ Click "Test Countries Data" to verify database has been reset with proper data',
      );
    </script>
  </body>
</html>
